<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán MoMo</title>
</head>
<body>
    <h1>Thanh Toán qua MoMo</h1>
    <form id="paymentForm">
        <label for="amount">Số tiền (VND):</label>
        <input type="text" id="amount" name="amount" value="50000" required><br><br>
        <input type="submit" value="Thanh toán">
    </form>

    <script>
        document.getElementById("paymentForm").addEventListener("submit", function(event) {
            event.preventDefault();  // Ngăn chặn trang tự động tải lại

            var amount = document.getElementById("amount").value;

            // Cấu hình tham số gửi lên MoMo
            var partnerCode = 'MOMO';
            var accessKey = 'F8BBA842ECF85';
            var secretKey = 'K951B6PE1waDMi640xX08PD3vg6EkVlz';
            var orderInfo = 'Thanh toán MoMo';
            var redirectUrl = 'https://webhook.site/your-redirect-url';
            var ipnUrl = 'https://webhook.site/your-ipn-url';
            var requestType = 'captureWallet';
            var extraData = '';
            var orderId = partnerCode + new Date().getTime();
            var requestId = orderId;

            // Tạo raw signature
            var rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&ipnUrl=${ipnUrl}&orderId=${orderId}&orderInfo=${orderInfo}&partnerCode=${partnerCode}&redirectUrl=${redirectUrl}&requestId=${requestId}&requestType=${requestType}`;
            console.log("Raw Signature:", rawSignature);

            // Tạo chữ ký HMAC SHA256
            var crypto = window.crypto || window.msCrypto;
            var enc = new TextEncoder().encode(rawSignature);
            crypto.subtle.importKey(
                "raw",
                new TextEncoder().encode(secretKey),
                { name: "HMAC", hash: { name: "SHA-256" } },
                false,
                ["sign"]
            ).then(function(key) {
                crypto.subtle.sign("HMAC", key, enc).then(function(signature) {
                    var signatureHex = Array.from(new Uint8Array(signature))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    console.log("Signature:", signatureHex);

                    // Chuẩn bị dữ liệu JSON để gửi
                    var requestBody = {
                        partnerCode: partnerCode,
                        accessKey: accessKey,
                        requestId: requestId,
                        amount: amount,
                        orderId: orderId,
                        orderInfo: orderInfo,
                        redirectUrl: redirectUrl,
                        ipnUrl: ipnUrl,
                        extraData: extraData,
                        requestType: requestType,
                        signature: signatureHex,
                        lang: 'vi'
                    };

                    // Gửi yêu cầu tới MoMo qua API
                    fetch('https://test-payment.momo.vn/v2/gateway/api/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Kết quả:', data);
                        if (data.payUrl) {
                            window.location.href = data.payUrl;  // Chuyển tới trang thanh toán
                        } else {
                            alert('Có lỗi xảy ra: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi:', error);
                        alert('Lỗi khi kết nối với MoMo');
                    });
                });
            });
        });
    </script>
</body>
</html>
